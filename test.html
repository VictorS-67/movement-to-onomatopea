<html>
  <head>
    <title>Sheets API Quickstart</title>
    <meta charset="utf-8" />
  </head>
  <body>
    <p>Sheets API Quickstart</p>

    <!--Add buttons to initiate auth sequence and sign out-->
    <button id="authorize_button">Authorize</button>
    <button id="signout_button">Sign Out</button>

    <pre id="content" style="white-space: pre-wrap;"></pre>

    <script src="https://apis.google.com/js/api.js"></script>
    <script type="text/javascript">


      const API_KEY = "AIzaSyCVd145ttSbU-E7uZy7pnzK8_zFFs9MabE";
      const CLIENT_ID = "42293635504-l6f9sdm8383v52dbbc8skqkadcboth1p.apps.googleusercontent.com";
      const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

      const spreadsheetId = '1wfTLMxPaXse6MRJp1q3ls5AX3oV2lc5ZDn8qNOYfdLA';
      const sheetName = 'Sheet1';

      // Function to get data from the sheet
      async function getSheetData() {
        try {
          const accessToken = await getAccessToken(); // Get OAuth2 access token
          const response = await fetch(
            `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${sheetName}`,
            {
              headers: {
                'Authorization': `Bearer ${accessToken}`, // Use the access token
              },
            }
          );
          const data = await response.json();
          return data.values;
        } catch (error) {
          console.error('Error fetching data:', error);
          throw error;
        }
      }
      
      // Function to append data to the sheet
      async function appendSheetData(newData) {
        try {
          const accessToken = await getAccessToken(); // Get OAuth2 access token
          const response = await fetch(
            `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${sheetName}:append?valueInputOption=RAW&insertDataOption=INSERT_ROWS`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${accessToken}`, // Use the access token
              },
              body: JSON.stringify({
                values: [newData],
              }),
            }
          );
          const result = await response.json();
          if (result.error) {
            console.error('Error appending data:', result.error);
            throw new Error('Failed to append data to sheet.');
          }
          return result;
        } catch (error) {
          console.error('Error:', error);
          throw error;
        }
      }
      // Function to get an OAuth 2.0 access token using a service account.
      async function getAccessToken() {
        return new Promise((resolve, reject) => {
          // 1. Load the Google API client library (gapi) - already in the HTML
          gapi.load('client', () => { // Changed from 'auth2' to 'client'
            // 2. Initialize the client with API key.  This is still needed.
            gapi.client.init({
              apiKey: API_KEY, // Replace with your API key
            }).then(() => {
              // 3. Authenticate using a service account.
              //    This example uses a Google Cloud Function to handle the service account logic.
              //    You'll need to deploy a function like this.
              fetch('https://your-cloud-function-url.com', {  //  Replace with your Cloud Function URL
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  spreadsheetId: spreadsheetId, //  Include spreadsheet ID
                  sheetName: sheetName
                }),
              })
              .then(response => response.json())
              .then(data => {
                if (data.access_token) {
                  resolve(data.access_token);
                } else {
                  reject(new Error('Failed to retrieve access token from Cloud Function: ' + data.error));
                }
              })
              .catch(error => {
                console.error('Error calling Cloud Function:', error);
                reject(error);
              });
            }).catch(error => {
              console.error("Error initializing gapi:", error);
              reject(error);
            });
          });
        });
      }
      
      // Example of how to use the functions:
      async function main() {
        try {
          const sheetData = await getSheetData();
          console.log('Sheet Data:', sheetData);
      
          // Example of data to append:
          const newData = ['test', '2.mp4', 'af',	0.45,	4.356,	35634574];
          const appendResult = await appendSheetData(newData);
          console.log('Append Result:', appendResult);
      
          const updatedSheetData = await getSheetData();
          console.log('Updated Sheet Data:', updatedSheetData);
        } catch (error) {
          console.error('An error occurred:', error);
        }
      }
      
      main();
      
            
    </script>

  </body>
</html>
